{
    "name": "From_Staging_to_DWH_TBLDEPARTMENT",
    "properties": {
        "folder": {
            "name": "HR"
        },
        "type": "MappingDataFlow",
        "typeProperties": {
            "sources": [
                {
                    "dataset": {
                        "referenceName": "ADLS_Staging",
                        "type": "DatasetReference"
                    },
                    "name": "source1"
                }
            ],
            "sinks": [
                {
                    "dataset": {
                        "referenceName": "AzureMySqlTable1",
                        "type": "DatasetReference"
                    },
                    "name": "sink1"
                }
            ],
            "transformations": [
                {
                    "name": "sourcesystemcode"
                },
                {
                    "name": "sourcesystemcode2"
                },
                {
                    "name": "derivehierarchy"
                },
                {
                    "name": "lookupparent"
                },
                {
                    "name": "derive_parent"
                },
                {
                    "name": "lookup_l1"
                },
                {
                    "name": "derive_l1"
                },
                {
                    "name": "lookup_l2"
                },
                {
                    "name": "derive_l2"
                },
                {
                    "name": "lookup_l3"
                },
                {
                    "name": "derive_l3"
                },
                {
                    "name": "lookup_l4"
                },
                {
                    "name": "derive_l4"
                },
                {
                    "name": "alterRow1"
                },
                {
                    "name": "select1"
                }
            ],
            "scriptLines": [
                "source(output(",
                "          DEPID as short,",
                "          DEPCODE as string,",
                "          NAME as string,",
                "          ISACTIVE as boolean,",
                "          PARENTID as string,",
                "          CREATED as string,",
                "          UPDATED as string,",
                "          COMPANYID as string,",
                "          DEPTYPEID as short,",
                "          PATH as string,",
                "          PARENTPATH as string",
                "     ),",
                "     allowSchemaDrift: true,",
                "     validateSchema: true,",
                "     inferDriftedColumnTypes: true,",
                "     ignoreNoFilesFound: false,",
                "     format: 'parquet') ~> source1",
                "source1 derive(source_system_code = 'ERP',",
                "          source_department_id = toString(DEPID),",
                "          source_company_id = iif(isNull(COMPANYID) || COMPANYID == '', 'MCK', toString(COMPANYID)),",
                "          department_code = DEPCODE,",
                "          department_name = NAME,",
                "          department_type_id = toInteger(DEPTYPEID),",
                "          source_parent_id = iif(isNull(PARENTID) || PARENTID == '', toString(null()), PARENTID),",
                "          department_path = PATH,",
                "          department_path_ids = iif(isNull(PARENTPATH) || PARENTPATH == '', '', trim(replace(replace(PARENTPATH, '|', '/'), '//', '/'))),",
                "          department_level = iif(isNull(PARENTPATH) || PARENTPATH == '', 0, length(toString(split(trim(replace(PARENTPATH, '|', '')), '|'))) - 1),",
                "          is_active = iif(ISACTIVE == true(), 1, 0),",
                "          source_created_date = toTimestamp(CREATED, 'yyyy.MM.dd HH:mm:ss'),",
                "          source_updated_date = toTimestamp(UPDATED, 'yyyy.MM.dd HH:mm:ss'),",
                "          etl_batch_id = toLong(currentUTC()),",
                "          dw_created_date = currentUTC(),",
                "          dw_updated_date = currentUTC()) ~> sourcesystemcode",
                "sourcesystemcode derive(path_parts = iif(isNull(department_path_ids) || department_path_ids == '', array(), split(trim(department_path_ids, '/'), '/'))) ~> sourcesystemcode2",
                "sourcesystemcode2 derive(path_parts = iif(isNull(department_path_ids) || department_path_ids == '', array(), split(trim(department_path_ids, '/'), '/')),",
                "          hierarchy_level1_dept_id = iif(length(toString(path_parts)) >= 1 && !isNull(path_parts[0]) && trim(path_parts[0]) != '', toString(path_parts[0]), toString(null())),",
                "          hierarchy_level2_dept_id = iif(length(toString(path_parts)) >= 2 && !isNull(path_parts[1]) &&  trim(path_parts[1]) != '', toString(path_parts[1]), toString(null())),",
                "          hierarchy_level3_dept_id = iif(length(toString(path_parts)) >= 3 && !isNull(path_parts[2]) && trim(path_parts[2]) != '', toString(path_parts[2]), toString(null())),",
                "          hierarchy_level4_dept_id = iif(length(toString(path_parts)) >= 4 && !isNull(path_parts[3]) && trim(path_parts[3]) != '', toString(path_parts[3]), toString(null())),",
                "          full_path_text = department_path,",
                "          is_top_level = iif(isNull(source_parent_id) || source_parent_id == '', 1, 0),",
                "          is_leaf_node = 0,",
                "          child_count = 0,",
                "          source_parent_id = source_parent_id) ~> derivehierarchy",
                "derivehierarchy lookup(derivehierarchy.source_parent_id == AzureMySqlTable1@source_department_id",
                "     && derive_hierarchy@source_system_code == AzureMySqlTable1@source_system_code",
                "     && AzureMySqlTable1@is_current_record == 1,",
                "     multiple: false,",
                "     pickup: 'any',",
                "     broadcast: 'auto')~> lookupparent",
                "lookupparent derive(parent_department_key = AzureMySqlTable1@department_key,",
                "          parent_department_name = AzureMySqlTable1@department_name,",
                "          parent_department_code = AzureMySqlTable1@department_code) ~> derive_parent",
                "derive_parent lookup(hierarchy_level1_dept_id == AzureMySqlTable1@source_department_id",
                "     && derive_parent@source_system_code == AzureMySqlTable1@source_system_code",
                "     && AzureMySqlTable1@is_current_record == 1,",
                "     multiple: false,",
                "     pickup: 'any',",
                "     broadcast: 'auto')~> lookup_l1",
                "lookup_l1 derive(hierarchy_level1_dept_key = AzureMySqlTable1@department_key,",
                "          hierarchy_level1_dept_name = AzureMySqlTable1@department_name,",
                "          hierarchy_level1_dept_code = AzureMySqlTable1@department_code) ~> derive_l1",
                "derive_l1 lookup(hierarchy_level2_dept_id == AzureMySqlTable1@source_department_id",
                "     && derive_l1@source_system_code == AzureMySqlTable1@source_system_code",
                "     && AzureMySqlTable1@is_current_record == 1,",
                "     multiple: false,",
                "     pickup: 'any',",
                "     broadcast: 'auto')~> lookup_l2",
                "lookup_l2 derive(hierarchy_level2_dept_key = AzureMySqlTable1@department_key,",
                "          hierarchy_level2_dept_name = AzureMySqlTable1@department_name,",
                "          hierarchy_level2_dept_code = AzureMySqlTable1@department_code) ~> derive_l2",
                "derive_l2 lookup(hierarchy_level3_dept_id == AzureMySqlTable1@source_department_id",
                "     && derive_l2@source_system_code == AzureMySqlTable1@source_system_code",
                "     && AzureMySqlTable1@is_current_record == 1,",
                "     multiple: false,",
                "     pickup: 'any',",
                "     broadcast: 'auto')~> lookup_l3",
                "lookup_l3 derive(hierarchy_level3_dept_key = AzureMySqlTable1@department_key,",
                "          hierarchy_level3_dept_name = AzureMySqlTable1@department_name,",
                "          hierarchy_level3_dept_code = AzureMySqlTable1@department_code) ~> derive_l3",
                "derive_l3 lookup(hierarchy_level4_dept_id == AzureMySqlTable1@source_department_id",
                "     && derive_l3@source_system_code == AzureMySqlTable1@source_system_code",
                "     && AzureMySqlTable1@is_current_record == 1,",
                "     multiple: false,",
                "     pickup: 'any',",
                "     broadcast: 'auto')~> lookup_l4",
                "lookup_l4 derive(hierarchy_level4_dept_key = AzureMySqlTable1@department_key,",
                "          hierarchy_level4_dept_name = AzureMySqlTable1@department_name,",
                "          hierarchy_level4_dept_code = AzureMySqlTable1@department_code) ~> derive_l4",
                "derive_l4 alterRow(upsertIf(true())) ~> alterRow1",
                "alterRow1 select(mapColumn(",
                "          source_system_code = {derive_l4@source_system_code},",
                "          source_department_id = {derive_l4@source_department_id},",
                "          source_company_id,",
                "          department_code = {derive_l4@department_code},",
                "          department_name = {derive_l4@department_name},",
                "          department_type_id,",
                "          parent_department_key,",
                "          source_parent_id = {sourcesystemcode@source_parent_id},",
                "          is_top_level,",
                "          department_path,",
                "          department_path_ids,",
                "          department_level,",
                "          hierarchy_level1_dept_key,",
                "          hierarchy_level1_dept_name,",
                "          hierarchy_level1_dept_code,",
                "          hierarchy_level2_dept_key,",
                "          hierarchy_level2_dept_name,",
                "          hierarchy_level2_dept_code,",
                "          hierarchy_level3_dept_key,",
                "          hierarchy_level3_dept_name,",
                "          hierarchy_level3_dept_code,",
                "          hierarchy_level4_dept_key,",
                "          hierarchy_level4_dept_name,",
                "          hierarchy_level4_dept_code,",
                "          full_path_text,",
                "          is_active,",
                "          is_leaf_node,",
                "          child_count,",
                "          source_created_date,",
                "          source_updated_date,",
                "          dw_created_date,",
                "          dw_updated_date,",
                "          etl_batch_id",
                "     ),",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true) ~> select1",
                "select1 sink(allowSchemaDrift: true,",
                "     validateSchema: false,",
                "     input(",
                "          department_key as integer,",
                "          source_system_code as string,",
                "          source_department_id as string,",
                "          company_key as integer,",
                "          source_company_id as string,",
                "          department_code as string,",
                "          department_name as string,",
                "          department_type_id as integer,",
                "          parent_department_key as integer,",
                "          source_parent_id as string,",
                "          is_top_level as integer,",
                "          department_path as string,",
                "          department_path_ids as string,",
                "          department_level as integer,",
                "          hierarchy_level1_dept_key as integer,",
                "          hierarchy_level1_dept_name as string,",
                "          hierarchy_level1_dept_code as string,",
                "          hierarchy_level2_dept_key as integer,",
                "          hierarchy_level2_dept_name as string,",
                "          hierarchy_level2_dept_code as string,",
                "          hierarchy_level3_dept_key as integer,",
                "          hierarchy_level3_dept_name as string,",
                "          hierarchy_level3_dept_code as string,",
                "          hierarchy_level4_dept_key as integer,",
                "          hierarchy_level4_dept_name as string,",
                "          hierarchy_level4_dept_code as string,",
                "          full_path_text as string,",
                "          is_active as integer,",
                "          is_leaf_node as integer,",
                "          child_count as integer,",
                "          effective_start_date as timestamp,",
                "          effective_end_date as timestamp,",
                "          is_current_record as integer,",
                "          source_created_date as timestamp,",
                "          source_updated_date as timestamp,",
                "          dw_created_date as timestamp,",
                "          dw_updated_date as timestamp,",
                "          etl_batch_id as long",
                "     ),",
                "     deletable:false,",
                "     insertable:true,",
                "     updateable:false,",
                "     upsertable:true,",
                "     keys:['source_system_code','source_department_id'],",
                "     format: 'table',",
                "     skipDuplicateMapInputs: true,",
                "     skipDuplicateMapOutputs: true,",
                "     saveOrder: 1) ~> sink1"
            ]
        }
    }
}